﻿@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewData["isDashBoard"] = true;
}

@* Summary for Widget *@
@* 
<div class="row mb-4 g-4">
    <!-- Total Income -->
    <div class="col-md-4">
        <div class="d-flex flex-row widget summary income">
            <div class="d-flex flex-column justify-content-center p-5">
                <i class="fa-solid fa-dollar-sign fa-2xl"></i>
            </div>
            <div class="d-flex flex-column m-auto py-3 text-center">
                <span class="lead">Total Income</span>
                <h1 class="display-6 fw-bold">@ViewBag.TotalIncome</h1>
            </div>
        </div>
    </div>

    <!-- Total Expense -->
    <div class="col-md-4">
        <div class="d-flex flex-row widget summary expense">
            <div class="d-flex flex-column justify-content-center p-5">
                <i class="fa-solid fa-dollar-sign fa-2xl"></i>
            </div>
            <div class="d-flex flex-column m-auto py-3 text-center">
                <span class="lead">Total Expense</span>
                <h1 class="display-6 fw-bold">@ViewBag.TotalExpense</h1>
            </div>
        </div>
    </div>

    <!-- Total Balance -->
    <div class="col-md-4">
        <div class="d-flex flex-row widget summary balance">
            <div class="d-flex flex-column justify-content-center p-5">
                <i class="fa-solid fa-dollar-sign fa-2xl"></i>
            </div>
            <div class="d-flex flex-column m-auto py-3 text-center">
                <span class="lead">Total Balance</span>
                <h1 class="display-6 fw-bold">@ViewBag.TotalBalance</h1>
            </div>
        </div>
    </div>
</div>
<div class="row mt-4 g-4">
    <!-- Doughnut Chart -->
    <div class="col-md-6">
        <div class="widget chart h-100">
            <div class="p-4 text-center">
                <h5 class="fw-bold">
                    <i class="fa fa-pie-chart me-2"></i> Expense By Category
                </h5>
            </div>

            <div style="width:100%; height:300px; margin:auto;">
                <canvas id="donutChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Spline Chart -->
    <div class="col-md-6">
        <div class="widget chart h-100">
            <div class="p-4 text-center">
                <h5 class="fw-bold">
                    <i class="fa fa-line-chart me-2"></i> Income vs Expense (Last 7 Days)
                </h5>
            </div>

            <div style="width:100%; height:300px;">
                <canvas id="splineChart"></canvas>
            </div>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-md-6">
        <div class="widget">
            <div class="p-4">
                <h5 class="fw-bold">Recent Transactions</h5>
            </div>

            <div class="px-4 pb-4">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Date</th>
                            <th class="text-end">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in ViewBag.RecentTransaction)
                        {
                            <tr>
                                <td>
                                    @item.Categories.Icon @item.Categories.Title
                                </td>
                                <td>
                                    @item.Date.ToString("dd-MM-yyyy")
                                </td>
                                <td class="text-end">
                                    @item.FormattedAmount
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

        </div>
    </div>
    <div class="col-md-6">
        <div class="widget h-100">
            <div class="d-flex justify-content-center align-items-center">
                <span><i class=" fa-solid fa-pluse fa-2xl"></i>Widget</span>
            </div>
        </div>
    </div>
</div>


<script>
    var labels = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Labels));
    var values = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Values));
    var formattedValues = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.FormattedValues));

    // --- Automatic Unique Color Generator ---
    function generateColors(count) {
        let colors = [];
        for (let i = 0; i < count; i++) {
            colors.push(`hsl(${Math.floor(Math.random() * 360)}, 70%, 55%)`);
        }
        return colors;
    }

    // --- Doughnut Chart ---
    new Chart(document.getElementById("donutChart"), {
        type: "doughnut",
        data: {
            labels: labels,
            datasets: [{
                data: values,
                borderWidth: 1,
                backgroundColor: generateColors(values.length)   // Dynamic auto-color
            }]
        },
        plugins: [ChartDataLabels],
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "55%",
            plugins: {
                legend: {
                    display: true,
                    position: "top",
                    labels: {
                        font: { weight: "bold" },
                        usePointStyle: true,
                    }
                },
                datalabels: {
                    color: "#000",
                    formatter: (value, ctx) => formattedValues[ctx.dataIndex],
                    font: { weight: "bold", size: 12 }
                }
            }
        }
    });
    new Chart(document.getElementById("splineChart"), {
        type: "line",
        data: {
            labels: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Days)),
            datasets: [
                {
                    label: "Income",
                    data: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Income7)),
                    borderWidth: 2,
                    tension: 0.4
                },
                {
                    label: "Expense",
                    data: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Expense7)),
                    borderWidth: 2,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

</script>
 *@


<div class="dashboard-container">

    <div class="row mb-4 g-4">

        <!-- Total Income -->
        <div class="col-md-4">
            <div class="widget summary income">
                <div class="icon-box d-flex justify-content-center align-items-center">
                    <i class="fa-solid fa-dollar-sign"></i>
                </div>

                <div class="ms-3 text-center flex-grow-1">
                    <span class="lead">Total Income</span>
                    <h1 class="display-6 fw-bold">@ViewBag.TotalIncome</h1>
                </div>
            </div>
        </div>

        <!-- Total Expense -->
        <div class="col-md-4">
            <div class="widget summary expense">
                <div class="icon-box d-flex justify-content-center align-items-center">
                    <i class="fa-solid fa-dollar-sign"></i>
                </div>

                <div class="ms-3 text-center flex-grow-1">
                    <span class="lead">Total Expense</span>
                    <h1 class="display-6 fw-bold">@ViewBag.TotalExpense</h1>
                </div>
            </div>
        </div>

        <!-- Total Balance -->
        <div class="col-md-4">
            <div class="widget summary balance">
                <div class="icon-box d-flex justify-content-center align-items-center">
                    <i class="fa-solid fa-dollar-sign"></i>
                </div>

                <div class="ms-3 text-center flex-grow-1">
                    <span class="lead">Total Balance</span>
                    <h1 class="display-6 fw-bold">@ViewBag.TotalBalance</h1>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row g-4 mt-2">
        <div class="col-md-6">
            <div class="chart-box">
                <h5 class="fw-bold text-center mb-3">
                    <i class="fa fa-pie-chart me-2"></i> Expense By Category
                </h5>
                <div id="categoryList" class="text-center mb-3"></div>
                <div class="chart-container">
                    <canvas id="donutChart"></canvas>
                </div>
            </div>

        </div>

        <div class="col-md-6">
            <div class="chart-box">
                <h5 class="fw-bold text-center mb-3">
                    <i class="fa fa-line-chart me-2"></i> Income vs Expense (Last 7 Days)
                </h5>

                <div class="chart-container">
                    <canvas id="splineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent transactions -->
        <div class="row g-4 mt-2 same-height">

            <div class="col-md-6">
                <div class="dashboard-card">
                    <h5 class="fw-bold mb-3">Recent Transactions</h5>

                    <table class="table table-dark table-striped table-bordered flex-grow-1">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Date</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in ViewBag.RecentTransaction)
                            {
                                <tr>
                                    <td>@item.Categories.Icon @item.Categories.Title</td>
                                    <td>@item.Date.ToString("dd-MM-yyyy")</td>
                                    <td class="text-end">@item.FormattedAmount</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                </div>
            </div>

            <div class="col-md-6">
                <div class="dashboard-card d-flex justify-content-center align-items-center">
                    <span><i class="fa-solid fa-plus fa-2xl"></i> Widget</span>
                </div>
            </div>

        </div>


<script>
        var labels = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Labels));
        var CategoryTitleWithIcon = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.CategoryTitleWithIcon));
        var values = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Values));
        var formattedValues = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.FormattedValues));

        // Generate colors ONCE, so both chart and legend use same colors
        function generateColors(count) {
            let colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(`hsl(${Math.floor(Math.random() * 360)}, 70%, 55%)`);
            }
            return colors;
        }

        const colors = generateColors(values.length);

        // Render CategoryTitleWithIcon under heading with matching colors
        const categoryListDiv = document.getElementById("categoryList");
        categoryListDiv.innerHTML = "";

        // Make sure the order of CategoryTitleWithIcon matches labels order!
        // Assuming CategoryTitleWithIcon array order matches labels and values

        CategoryTitleWithIcon.forEach((item, index) => {
            categoryListDiv.innerHTML += `
                    <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:5px; font-size:14px;">
                        <span style="width:14px; height:14px; background:${colors[index]}; display:inline-block; border-radius:3px;"></span>
                        <span>${item}</span>
                    </div>
                `;
        });

        // Create Doughnut Chart with generated colors
        new Chart(document.getElementById("donutChart"), {
            type: "doughnut",
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    borderWidth: 1,
                    backgroundColor: colors
                }]
            },
            plugins: [ChartDataLabels],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: "55%",
                plugins: {
                    legend: {
                        display: false // We hide default legend because we have custom one below heading
                    },
                    datalabels: {
                        color: "#000",
                        formatter: (value, ctx) => formattedValues[ctx.dataIndex],
                        font: { weight: "bold", size: 12 }
                    }
                }
            }
        });

    new Chart(document.getElementById("splineChart"), {
        type: "line",
        data: {
            labels: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Days)),
            datasets: [
                {
                    label: "Income",
                    data: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Income7)),
                    borderWidth: 2,
                    tension: 0.4
                },
                {
                    label: "Expense",
                    data: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Expense7)),
                    borderWidth: 2,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

</script>